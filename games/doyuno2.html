<!DOCTYPE html>
<meta name="robots" content="noindex">
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>BLOCKUS</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/konva@2.4.2/konva.min.js"></script>
  </head>
  <body>
    <div id="container"></div>
    
    <button type="button" class="btn btn-primary" style="position: absolute; bottom: 0px; right: 0px;" data-toggle="modal" data-target="#exampleModal">
      Choose piece
    </button>

    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Choose piece</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div id="container_modal"></div>
        </div>
      </div>
    </div>

    <script id="jsbin-javascript">
    var BASE = 19, SIZE = 20;

    // define pieces
    var NUMBER_OF_PLAYERS = 4, PLAYER_NO = 3, START_POINTS = [[0,0], [SIZE-1,0], [0,SIZE-1], [SIZE-1,SIZE-1]];
    var PLAYERS_COLOR = ["#e74c3c", "#3498db", "#2ecc71", "#9b59b6"];
    var p_types = {}, groups = {}, state, modal_stage;
    var active_piece, stage, board_layer, piece_layer, active_piece_layer, state_layer;
    p_types.p_1 = [[[[0,0]],[[0,0]],[[0,0]],[[0,0]]],[[[0,0]],[[0,0]],[[0,0]],[[0,0]]]];
    p_types.p_2 = [[[[0,0],[0,1]],[[0,0],[1,0]],[[0,0],[0,1]],[[0,0],[1,0]]],[[[0,0],[0,1]],[[0,0],[1,0]],[[0,0],[0,1]],[[0,0],[1,0]]]];
    p_types.p_v3 = [[[[0,0],[0,1],[1,1]],[[0,0],[0,1],[1,0]],[[0,0],[1,0],[1,1]],[[0,1],[1,0],[1,1]]],[[[1,0],[1,1],[0,1]],[[1,0],[1,1],[0,0]],[[1,0],[0,0],[0,1]],[[1,1],[0,0],[0,1]]]];
    p_types.p_i3 = [[[[0,0],[1,0],[2,0]],[[0,0],[0,1],[0,2]],[[0,0],[1,0],[2,0]],[[0,0],[0,1],[0,2]]],[[[0,0],[1,0],[2,0]],[[0,0],[0,1],[0,2]],[[0,0],[1,0],[2,0]],[[0,0],[0,1],[0,2]]]];
    p_types.p_t4 = [[[[0,0],[1,0],[1,1],[2,0]],[[0,1],[1,0],[1,1],[1,2]],[[0,1],[1,0],[1,1],[2,1]],[[0,0],[0,1],[0,2],[1,1]]],[[[0,0],[1,0],[1,1],[2,0]],[[0,0],[0,1],[0,2],[1,1]],[[0,1],[1,0],[1,1],[2,1]],[[0,1],[1,0],[1,1],[1,2]]]]
    p_types.p_o = [[[[0,0],[0,1],[1,0],[1,1]],[[0,0],[0,1],[1,0],[1,1]],[[0,0],[0,1],[1,0],[1,1]],[[0,0],[0,1],[1,0],[1,1]]],[[[0,0],[0,1],[1,0],[1,1]],[[0,0],[0,1],[1,0],[1,1]],[[0,0],[0,1],[1,0],[1,1]],[[0,0],[0,1],[1,0],[1,1]]]];
    p_types.p_l4 = [[[[0,0],[0,1],[1,1],[2,1]],[[0,0],[0,1],[0,2],[1,0]],[[0,0],[1,0],[2,0],[2,1]],[[0,2],[1,0],[1,1],[1,2]]],[[[0,1],[1,1],[2,0],[2,1]],[[0,0],[1,0],[1,1],[1,2]],[[0,0],[0,1],[1,0],[2,0]],[[0,0],[0,1],[0,2],[1,2]]]];
    p_types.p_i4 = [[[[0,0],[1,0],[2,0],[3,0]],[[0,0],[0,1],[0,2],[0,3]],[[0,0],[1,0],[2,0],[3,0]],[[0,0],[0,1],[0,2],[0,3]]],[[[0,0],[1,0],[2,0],[3,0]],[[0,0],[0,1],[0,2],[0,3]],[[0,0],[1,0],[2,0],[3,0]],[[0,0],[0,1],[0,2],[0,3]]]];
    p_types.p_z4 = [[[[0,0],[1,0],[1,1],[2,1]],[[0,1],[0,2],[1,0],[1,1]],[[0,0],[1,0],[1,1],[2,1]],[[0,1],[0,2],[1,0],[1,1]]],[[[0,1],[1,0],[1,1],[2,0]],[[0,0],[0,1],[1,1],[1,2]],[[0,1],[1,0],[1,1],[2,0]],[[0,0],[0,1],[1,1],[1,2]]]];
    p_types.p_f = [[[[0,1],[0,2],[1,0],[1,1],[2,1]],[[0,0],[1,0],[1,1],[1,2],[2,1]],[[0,1],[1,1],[1,2],[2,0],[2,1]],[[0,1],[1,0],[1,1],[1,2],[2,2]]],[[[2,1],[2,2],[1,0],[1,1],[0,1]],[[2,0],[1,0],[1,1],[1,2],[0,1]],[[2,1],[1,1],[1,2],[0,0],[0,1]],[[2,1],[1,0],[1,1],[1,2],[0,2]]]];
    p_types.p_x = [[[[0,1],[1,0],[1,1],[1,2],[2,1]],[[0,1],[1,0],[1,1],[1,2],[2,1]],[[0,1],[1,0],[1,1],[1,2],[2,1]],[[0,1],[1,0],[1,1],[1,2],[2,1]]],[[[0,1],[1,0],[1,1],[1,2],[2,1]],[[0,1],[1,0],[1,1],[1,2],[2,1]],[[0,1],[1,0],[1,1],[1,2],[2,1]],[[0,1],[1,0],[1,1],[1,2],[2,1]]]];
    p_types.p_p = [[[[0,0],[0,1],[0,2],[1,0],[1,1]],[[0,0],[1,0],[1,1],[2,0],[2,1]],[[0,1],[0,2],[1,0],[1,1],[1,2]],[[0,0],[0,1],[1,0],[1,1],[2,1]]] ,[[[0,0],[0,1],[1,0],[1,1],[1,2]],[[0,0],[0,1],[1,0],[1,1],[2,0]],[[0,0],[0,1],[0,2],[1,1],[1,2]],[[0,1],[1,0],[1,1],[2,0],[2,1]]]];
    p_types.p_w = [[[[0,0],[0,1],[1,1],[1,2],[2,2]],[[0,1],[0,2],[1,0],[1,1],[2,0]],[[0,0],[1,0],[1,1],[2,1],[2,2]],[[0,2],[1,1],[1,2],[2,0],[2,1]]],[[[2,0],[2,1],[1,1],[1,2],[0,2]],[[2,1],[2,2],[1,0],[1,1],[0,0]],[[2,0],[1,0],[1,1],[0,1],[0,2]],[[2,2],[1,1],[1,2],[0,0],[0,1]]]];
    p_types.p_z5 = [[[[0,1],[0,2],[1,1],[2,0],[2,1]],[[0,0],[1,0],[1,1],[1,2],[2,2]],[[0,1],[0,2],[1,1],[2,0],[2,1]],[[0,0],[1,0],[1,1],[1,2],[2,2]]],[[[2,1],[2,2],[1,1],[0,0],[0,1]],[[2,0],[1,0],[1,1],[1,2],[0,2]],[[2,1],[2,2],[1,1],[0,0],[0,1]],[[2,0],[1,0],[1,1],[1,2],[0,2]]]];
    p_types.p_y = [[[[0,0],[1,0],[1,1],[2,0],[3,0]],[[0,1],[1,0],[1,1],[1,2],[1,3]],[[0,1],[1,1],[2,0],[2,1],[3,1]],[[0,0],[0,1],[0,2],[0,3],[1,2]]],[[[0,0],[1,0],[2,0],[2,1],[3,0]],[[0,0],[0,1],[0,2],[0,3],[1,1]],[[0,1],[1,0],[1,1],[2,1],[3,1]],[[0,2],[1,0],[1,1],[1,2],[1,3]]]];
    p_types.p_l5 = [[[[0,0],[0,1],[1,1],[2,1],[3,1]],[[0,0],[0,1],[0,2],[0,3],[1,0]],[[0,0],[1,0],[2,0],[3,0],[3,1]],[[0,3],[1,0],[1,1],[1,2],[1,3]]],[[[0,1],[1,1],[2,1],[3,0],[3,1]],[[0,0],[1,0],[1,1],[1,2],[1,3]],[[0,0],[0,1],[1,0],[2,0],[3,0]],[[0,0],[0,1],[0,2],[0,3],[1,3]]]];
    p_types.p_u = [[[[0,0],[0,1],[1,1],[2,0],[2,1]],[[0,0],[0,1],[0,2],[1,0],[1,2]],[[0,0],[0,1],[1,0],[2,0],[2,1]],[[0,0],[0,2],[1,0],[1,1],[1,2]]] ,[[[0,0],[0,1],[1,1],[2,0],[2,1]],[[0,0],[0,2],[1,0],[1,1],[1,2]],[[0,0],[0,1],[1,0],[2,0],[2,1]],[[0,0],[0,1],[0,2],[1,0],[1,2]]] ];
    p_types.p_t5 = [[[[0,2],[1,0],[1,1],[1,2],[2,2]],[[0,0],[0,1],[0,2],[1,1],[2,1]],[[0,0],[1,0],[1,1],[1,2],[2,0]],[[0,1],[1,1],[2,0],[2,1],[2,2]]] ,[[[0,2],[1,0],[1,1],[1,2],[2,2]],[[0,1],[1,1],[2,0],[2,1],[2,2]],[[0,0],[1,0],[1,1],[1,2],[2,0]],[[0,0],[0,1],[0,2],[1,1],[2,1]]] ];
    p_types.p_v5 = [[[[0,0],[0,1],[0,2],[1,2],[2,2]],[[0,0],[0,1],[0,2],[1,0],[2,0]],[[0,0],[1,0],[2,0],[2,1],[2,2]],[[0,2],[1,2],[2,0],[2,1],[2,2]]] ,[[[2,0],[2,1],[2,2],[1,2],[0,2]],[[2,0],[2,1],[2,2],[1,0],[0,0]],[[2,0],[1,0],[0,0],[0,1],[0,2]],[[2,2],[1,2],[0,0],[0,1],[0,2]]]];
    p_types.p_n = [[[[0,1],[1,0],[1,1],[2,0],[3,0]],[[0,0],[0,1],[1,1],[1,2],[1,3]],[[0,1],[1,1],[2,0],[2,1],[3,0]],[[0,0],[0,1],[0,2],[1,2],[1,3]]],[[[0,0],[1,0],[2,0],[2,1],[3,1]],[[0,1],[0,2],[0,3],[1,0],[1,1]],[[0,0],[1,0],[1,1],[2,1],[3,1]],[[0,2],[0,3],[1,0],[1,1],[1,2]]] ];
    p_types.p_i5 = [[[[0,0],[0,1],[0,2],[0,3],[0,4]],[[0,0],[1,0],[2,0],[3,0],[4,0]],[[0,0],[0,1],[0,2],[0,3],[0,4]],[[0,0],[1,0],[2,0],[3,0],[4,0]]] ,[[[0,0],[0,1],[0,2],[0,3],[0,4]],[[0,0],[1,0],[2,0],[3,0],[4,0]],[[0,0],[0,1],[0,2],[0,3],[0,4]],[[0,0],[1,0],[2,0],[3,0],[4,0]]] ];
    
    function isItemInArray(array, item) {
      for (var i = 0; i < array.length; i++) {
        if (array[i][0] == item[0] && array[i][1] == item[1]) return true;
      }
      return false;
    }

    Array.prototype.diff = function(a) {
      return this.filter(function(i) {return isItemInArray(a, i)});
    }

    function back_active_piece() {
      active_piece.x(BASE*SIZE/3);
      active_piece.y(BASE*(SIZE + 2));
    }

    function draw_active_piece() {
      active_piece.find("Rect").remove();
      if (active_piece.type == "") return;
      $.each(p_types[active_piece.type][active_piece.flip][active_piece.angle], function(i, e){
        active_piece.add(new Konva.Rect({
          x: e[0]*BASE, y: e[1]*BASE,
          width: BASE, height: BASE,
          fill: PLAYERS_COLOR[active_piece.player_no - 1]
        }));
      });
      active_piece_layer.draw();
    }

    function draw_state_layer() {
      state_layer.destroyChildren();
      $.each(state, function(i, e){
        $.each(e, function(j, f){
          if (f != 0) {
            state_layer.add(new Konva.Rect({
              x: i*BASE, y: j*BASE,
              width: BASE, height: BASE,
              fill: PLAYERS_COLOR[f-1]
            }));
          }
        });
      });
      if (active_piece.player_no) {
        $.each(must_list(active_piece.player_no).diff(white_list(active_piece.player_no)), function(i, e){
          state_layer.add(new Konva.Circle({
            x: e[0]*BASE + BASE/2, y: e[1]*BASE + BASE/2,
            radius: BASE/4,
            fill: PLAYERS_COLOR[active_piece.player_no-1],
            opacity: 0.5
          }));
        });
        $.each(white_list(active_piece.player_no), function(i, e){
          state_layer.add(new Konva.Circle({
            x: e[0]*BASE + BASE/2, y: e[1]*BASE + BASE/2,
            radius: BASE/8,
            fill: PLAYERS_COLOR[active_piece.player_no-1],
            opacity: 0.25
          }));
        });
      }
      state_layer.draw();
    }

    function place_player_move(player_no, affect_positions) {
      $.each(affect_positions, function(i, e){
        state[e[0]][e[1]] = player_no;
        draw_state_layer();
        if (player_no == PLAYER_NO) {
          piece_layer.find("#click_group_" + active_piece.type).remove();
          piece_layer.draw();
          active_piece.type = "";
          back_active_piece();
          draw_active_piece();
        }
      });
    }

    function must_list(player_no) {
      list = [];
      var first_move = true;
      $.each(state, function(i, e){
        $.each(e, function(j, f){
          if (f == player_no) {
            first_move = false;
            $.each([[1,1],[1,-1],[-1,1],[-1,-1]], function(k, g){
              var candidate = [i + g[0], j + g[1]];
              if (candidate[0] >= 0 && candidate[0] < SIZE && candidate[1] >= 0 && candidate[1] < SIZE && state[candidate[0]][candidate[1]] == 0) {
                list.push(candidate);
              }
            });
          }
        });
      });
      return first_move ? [START_POINTS[player_no-1]] : list;
    }

    function white_list(player_no) {
      list = [];
      $.each(state, function(i, e){
        $.each(e, function(j, f){
          if (f == 0) {
            var check = true;
            $.each([[1,0],[-1,0],[0,1],[0,-1]], function(k, g){
              var candidate = [i + g[0], j + g[1]];
              if (candidate[0] >= 0 && candidate[0] < SIZE && candidate[1] >= 0 && candidate[1] < SIZE && state[candidate[0]][candidate[1]] == player_no) {
                check = false;
              }
            });
            if (check) list.push([i, j]);
          }
        });
      });
      return list;
    }

    function check_suitable(player_no, data) {
      var wl = white_list(player_no);
      var ml = must_list(player_no).diff(wl);
      var contains_must_point = false;
      var all_white_point = true;
      $.each(data, function(i, e){
        if (isItemInArray(ml, e)) contains_must_point = true;
        if (!isItemInArray(wl, e)) {
          all_white_point = false;
          return false;
        }
      });
      return all_white_point && contains_must_point;
    }

    $(function(){
      state = [];
      for (var i=0; i<SIZE; i++) {
        state[i] = [];
        for (var j=0; j<SIZE; j++) {
          state[i][j] = 0;
        }
      }
      stage = new Konva.Stage({
        container: "container",
        width: BASE*SIZE,
        height: BASE*(SIZE+7)
      });

      modal_stage = new Konva.Stage({
        container: "container_modal",
        width: BASE*SIZE,
        height: BASE*SIZE
      });
      
      board_layer = new Konva.Layer();
      piece_layer = new Konva.Layer();
      active_piece_layer = new Konva.Layer();
      state_layer = new Konva.Layer();
      
      for (var i=0; i<=SIZE; i++) {
        board_layer.add(new Konva.Line({
          points: [0,i*BASE,BASE*SIZE,i*BASE],
          stroke: "#7f8c8d"
        }));
        board_layer.add(new Konva.Line({
          points: [i*BASE,0,i*BASE,BASE*SIZE],
          stroke: "#7f8c8d"
        }));
      }

      var counter = 0;
      
      $.each(p_types, function(k, v){
        groups[k] = new Konva.Group({id: "click_group_" + k, player_no: PLAYER_NO});
        $.each(v[0][0], function(i, e){
          groups[k].add(new Konva.Rect({
            x: e[0]*15, y: e[1]*15,
            width: 15, height: 15,
            fill: PLAYERS_COLOR[PLAYER_NO-1]
          }));
        });
        groups[k].x(BASE + (counter % 5)*70);
        groups[k].y(BASE + parseInt(counter/5)*BASE*3);
        groups[k].on("click tap", function(){
          $("#exampleModal").modal("hide");
          active_piece.type = k;
          active_piece.player_no = this.attrs.player_no;
          active_piece.flip = 0;
          active_piece.angle = 0;
          draw_state_layer();
          draw_active_piece();
        });
        piece_layer.add(groups[k]);
        counter++;
      });

      active_piece = new Konva.Group({draggable: true});
      active_piece_layer.add(active_piece);
      active_piece.type = "";
      active_piece.player_no = PLAYER_NO;
      active_piece.flip = 0;
      active_piece.angle = 0;
      $.each(["flipx", "flipy", "rotater", "rotatel"], function(i, e){
        active_piece.add(new Konva.Text({
          x: i < 2 ? BASE + BASE*2*i : -BASE*1.5,
          y: i < 2 ? -BASE*1.5 : BASE + BASE*2*(i-2),
          text: ["↕","↔","↻","↺"][i],
          fontSize: 18,
          id: e
        }));
      });
      back_active_piece();
      draw_active_piece();
      
      active_piece.find("#rotater").on("click tap", function(){
        if (active_piece.type == "") return;
        active_piece.angle = (active_piece.angle + 1*(active_piece.flip == 0 ? 1 : -1)) % 4;
        if (active_piece.angle < 0) active_piece.angle += 4;
        draw_active_piece();
      });

      active_piece.find("#rotatel").on("click tap", function(){
        if (active_piece.type == "") return;
        active_piece.angle = (active_piece.angle - 1*(active_piece.flip == 0 ? 1 : -1)) % 4;
        if (active_piece.angle < 0) active_piece.angle += 4;
        draw_active_piece();
      });

      active_piece.find("#flipy").on("click tap", function(){
        if (active_piece.type == "") return;
        active_piece.flip = (active_piece.flip + 1) % 2;
        draw_active_piece();
      });

      active_piece.find("#flipx").on("click tap", function(){
        if (active_piece.type == "") return;
        active_piece.flip = (active_piece.flip + 1) % 2;
        active_piece.angle = (active_piece.angle + 2*(active_piece.flip == 0 ? 1 : -1)) % 4;
        if (active_piece.angle < 0) active_piece.angle += 4;
        draw_active_piece();
      });

      active_piece.on("dragend", function(e){
        if (active_piece.type == "") return;
        var diff_x = active_piece.x() + BASE * 0.25;
        var diff_y = active_piece.y() + BASE * 0.25;
        if (Math.round(diff_x/BASE) <= SIZE && Math.round(diff_x/BASE) >= 0 && Math.round(diff_y/BASE) <= SIZE && Math.round(diff_y/BASE) >= 0 && diff_x % BASE < BASE * 0.5 && diff_y % BASE < BASE * 0.5) {
          var target_x = Math.round(diff_x/BASE);
          var target_y = Math.round(diff_y/BASE);
          
          var affect_positions = p_types[active_piece.type][active_piece.flip][active_piece.angle].map(function(e){return [target_x + e[0], target_y + e[1]]});

          if (check_suitable(active_piece.player_no, affect_positions)) {
            place_player_move(active_piece.player_no, affect_positions);
          } else {
            back_active_piece();
            active_piece_layer.draw();
          }
          stage.draw();
        } else {
          back_active_piece();
          active_piece_layer.draw();
        }
      });

      stage.add(board_layer);
      modal_stage.add(piece_layer);
      stage.add(state_layer);
      stage.add(active_piece_layer);
    });
    </script>
  </body>
</html>
