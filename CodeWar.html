<html>
  <head>
    <title>CodeWar</title>
    <script>
      var state;
      document.addEventListener("DOMContentLoaded", function(event) {
        // Player moves & status init
        var STATUS = {"STABLE":"1", "UNSTABLE":"2"}
        var PLAYER_MOVES = {"EMPTY":"0"}
        var count = 1
        for (var i = 1; i<=4; i++) {
          PLAYER_MOVES[i+STATUS["STABLE"]] = count++ + "";
          PLAYER_MOVES[i+STATUS["UNSTABLE"]] = count++ + "";
        }
        // Colors init
        var BACKGROUND_STROKE_COLOR = "#95a5a6";
        var BACKGROUND_FILL_COLOR = "#ecf0f1";
        var CURRENT_POSITIONS_COLOR = "#2c3e50";
        var POINT_COLORS = {};
        POINT_COLORS[PLAYER_MOVES[1+STATUS["STABLE"]]] = "#c0392b";
        POINT_COLORS[PLAYER_MOVES[1+STATUS["UNSTABLE"]]] = "#e74c3c";
        POINT_COLORS[PLAYER_MOVES[2+STATUS["STABLE"]]] = "#2980b9";
        POINT_COLORS[PLAYER_MOVES[2+STATUS["UNSTABLE"]]] = "#3498db";
        POINT_COLORS[PLAYER_MOVES[3+STATUS["STABLE"]]] = "#27ae60";
        POINT_COLORS[PLAYER_MOVES[3+STATUS["UNSTABLE"]]] = "#2ecc71";
        POINT_COLORS[PLAYER_MOVES[4+STATUS["STABLE"]]] = "#8e44ad";
        POINT_COLORS[PLAYER_MOVES[4+STATUS["UNSTABLE"]]] = "#9b59b6";
        
        // Canvas init
        var WIDTH = 800;
        var HEIGHT = 600;
        var UNIT = 20;
        var canvas = document.getElementById("canvas");
        canvas.width = WIDTH;
        canvas.height = HEIGHT;
        var ctx = canvas.getContext("2d");
        
        // State init
        state = new Array(HEIGHT/UNIT);
        for (var i = 0; i < HEIGHT/UNIT; i++) {
          state[i] = new Array(WIDTH/UNIT);
        }
        reset_state();
        var current_positions = [];

        // Main
        // Wait to sample game log
        
        // Extend methods
        function reset_state() {
          for (var i = 0; i < HEIGHT/UNIT; i++) {
            for (var j = 0; j < WIDTH/UNIT; j++) {
              state[i][j] = PLAYER_MOVES["EMPTY"];
            }
          }
        }
        function draw() {
          // console.log("=== PAINT! ===");
          ctx.clearRect(0, 0, WIDTH, HEIGHT);
          draw_background();
          draw_state();
          draw_current_positions();
        }

        function draw_background() {
          // console.log("draw_background");
          ctx.beginPath();
          ctx.strokeStyle = BACKGROUND_STROKE_COLOR;
          for (var i = 0; i <= HEIGHT/UNIT; i++) {
            ctx.moveTo(0, i*UNIT);
            ctx.lineTo(WIDTH, i*UNIT);
          }
          for (var i = 0; i <= WIDTH/UNIT; i++) {
            ctx.moveTo(i*UNIT, 0);
            ctx.lineTo(i*UNIT, HEIGHT);
          }
          ctx.closePath();
          ctx.stroke();
        }

        function draw_state() {
          // console.log("draw_state");
          for (var i = 0; i < HEIGHT/UNIT; i++) {
            for (var j = 0; j < WIDTH/UNIT; j++) {
              if (state[i][j] != PLAYER_MOVES["EMPTY"]) {
                ctx.fillStyle = POINT_COLORS[state[i][j]];
                ctx.fillRect(j*UNIT, i*UNIT, UNIT, UNIT);
              }
            }
          }
        }

        function draw_current_positions() {
          for (var i = 0; i < current_positions.length; i++) {
            ctx.fillStyle = CURRENT_POSITIONS_COLOR;
            ctx.fillRect(current_positions[i][1]*UNIT + UNIT/4, current_positions[i][0]*UNIT + UNIT/4, UNIT/2, UNIT/2);
          }
        }

        // DEMO FOR SERVER SIDE
        var player_no = 2;
        current_positions = [[0, 0],[10, 10],[0, 0],[0, 0]];
        state[10][10] = PLAYER_MOVES[player_no + "1"];
        state[11][11] = PLAYER_MOVES["11"];
        draw();
        
        document.addEventListener("keydown", function(event) {
          var key = event.which;
          if (key == "37") {
            current_positions[player_no-1] = [current_positions[player_no-1][0], current_positions[player_no-1][1] - 1];
          } else if (key == "38") {
            current_positions[player_no-1] = [current_positions[player_no-1][0] - 1, current_positions[player_no-1][1]];
          } else if (key == "39") {
            current_positions[player_no-1] = [current_positions[player_no-1][0], current_positions[player_no-1][1] + 1];
          } else if(key == "40") {
            current_positions[player_no-1] = [current_positions[player_no-1][0] + 1, current_positions[player_no-1][1]];
          }
          if (check_unvalid_position(current_positions[player_no-1]) || state[current_positions[player_no-1][0]][current_positions[player_no-1][1]] == PLAYER_MOVES[player_no + STATUS["UNSTABLE"]]) {
            // console.log("LOSE!");
            reset_demo();
          } else if (state[current_positions[player_no-1][0]][current_positions[player_no-1][1]] == PLAYER_MOVES[player_no + STATUS["STABLE"]]) {
            check_state();
          } else {
            state[current_positions[player_no-1][0]][current_positions[player_no-1][1]] = PLAYER_MOVES[player_no + STATUS["UNSTABLE"]];
          }
          draw();
        });

        function reset_demo() {
          reset_state();
          current_positions[player_no-1] = [10, 10];
          state[10][10] = PLAYER_MOVES[player_no + "1"];
        }

        function check_state() {
          for (var i = 0; i < HEIGHT/UNIT; i++) {
            for (var j = 0; j < WIDTH/UNIT; j++) {
              if (state[i][j] == PLAYER_MOVES[player_no + STATUS["UNSTABLE"]]) {
                state[i][j] = PLAYER_MOVES[player_no + STATUS["STABLE"]];
              }
            }
          }
          for (var i = 0; i < HEIGHT/UNIT; i++) {
            for (var j = 0; j < WIDTH/UNIT; j++) {
              if (check_point_inside(i, j)) {
                state[i][j] = PLAYER_MOVES[player_no + STATUS["STABLE"]];
              }
            }
          }
        }

        function check_point_inside(i, j) {
          result = recursion_check(i, j);
          for (var i = 0; i < HEIGHT/UNIT; i++) {
            for (var j = 0; j < WIDTH/UNIT; j++) {
              if (state[i][j].length > 1) {
                state[i][j] = state[i][j][0];
              }
            }
          }
          // console.log(result);
          return result;
        }

        function recursion_check(i, j) {
          // console.log(i + " " + j);
          if (check_unvalid_position([i, j])) {
            return false;
          }
          if (state[i][j] == PLAYER_MOVES[player_no + STATUS["STABLE"]] || state[i][j].length > 1) {
            return true;
          }
          state[i][j] = state[i][j] + "TEMP";
          if (!recursion_check(i+1, j) || !recursion_check(i+1, j+1) || !recursion_check(i, j+1) || !recursion_check(i-1, j+1) || !recursion_check(i-1, j) || !recursion_check(i-1, j-1) || !recursion_check(i, j-1) || !recursion_check(i+1, j-1)) {
            return false
          }
          return true
        }

        function check_unvalid_position(position) {
          if (position[0]<0 || position[0]>(HEIGHT/UNIT - 1) || position[1]<0 || position[1]>(WIDTH/UNIT -1)) {
            return true;
          }
          return false;
        }
      });
    </script>
  </head>
  <body>
    <canvas id="canvas"></canvas>
  </body>
</html>